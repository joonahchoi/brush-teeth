<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>양치 인증 앱</title>
  <style>
    :root{
      --APP-W: 1080px;
      --APP-H: 1418px;
      --bg1: #74b9ff;
      --bg2: #0984e3;
      --ink: #2d3436;
      --sub: #636e72;
      --ok1: #00b894;
      --ok2: #00a085;
      --acc: #fd79a8;
    }
    /* 화면 중앙 정렬 + 배경 */
    html, body {
      height: 100%;
      margin: 0;
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      overflow: hidden; /* 바깥 스크롤 방지 */
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    /* 스케일 래퍼: 어떤 화면에서도 비율 유지 */
    .stage {
      width: 100vw;
      height: 100vh;
      display: grid;
      place-items: center;
    }
    /* 실제 앱 캔버스: 1080 x 1418 고정 */
    #app {
      width: var(--APP-W);
      height: var(--APP-H);
      background: white;
      border-radius: 24px;
      box-shadow: 0 24px 50px rgba(0,0,0,0.15);
      overflow: hidden; /* 내부에서만 스크롤 관리 */
      position: relative;
      transform-origin: top left; /* JS 스케일 기준점 */
    }

    /* 내부 레이아웃 */
    .container {
      height: 100%;
      display: flex;
      flex-direction: column;
      padding: 40px 48px;
    }

    .header { margin-bottom: 28px; text-align: center; }
    .header h1 { color: var(--ink); font-size: 40px; margin: 6px 0 6px; }
    .header .emoji { font-size: 64px; display: block; }
    .header p { color: var(--ink); opacity: .85; }

    .form-group { margin-bottom: 20px; }
    .form-label { display:block; margin-bottom:10px; color:var(--ink); font-weight:700; font-size:18px; }
    select, input[type="text"]{
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e6e8ec;
      border-radius: 12px;
      font-size: 18px;
      outline: none;
      transition: border-color .25s ease;
      background: #fff;
    }
    select:focus, input[type="text"]:focus { border-color: var(--bg1); }

    .inline-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

    .helper {
      margin-top: 6px; font-size: 14px; color: var(--ink);
      background:#eaf4ff; padding: 12px 14px; border-radius: 10px;
      line-height: 1.4;
    }

    .btn {
      display: inline-flex; align-items: center; justify-content: center;
      background: linear-gradient(135deg, var(--ok1), var(--ok2));
      color: #fff; border: none; padding: 16px 24px;
      border-radius: 999px; font-size: 18px; font-weight: 800;
      cursor: pointer; transition: transform .2s, box-shadow .2s;
      width: 100%;
    }
    .btn:hover { transform: translateY(-2px); box-shadow:0 12px 24px rgba(0,184,148,.25); }
    .btn:disabled { background:#d6d8db; cursor:not-allowed; transform:none; box-shadow:none; }
    .btn-secondary { background:#636e72; }
    .btn-pink { background: var(--acc); }
    .btn-pink:hover { background:#e84393; }

    .camera-container { display:none; flex-direction:column; gap: 18px; }

    .student-info {
      background:#f7f9fb; padding:16px 18px; border-radius:12px; display:none;
    }
    .student-info h3 { margin:0 0 6px; color:var(--ink); font-size: 22px; }
    .timestamp { margin:0; color:var(--sub); font-size:16px; }

    .camera-placeholder {
      width: 100%;
      max-width: 520px;
      height: 380px;
      margin: 0 auto;
      background:#f8f9fa;
      border: 3px dashed var(--bg1);
      border-radius: 16px;
      display:flex; align-items:center; justify-content:center; flex-direction:column;
      color: var(--sub); text-align: center; padding: 16px;
    }

    .success-message {
      display:none; background:var(--ok1); color:#fff; padding:16px; border-radius:12px;
      animation:fadeIn .4s ease-in;
    }
    @keyframes fadeIn { from {opacity:0; transform:translateY(6px);} to {opacity:1; transform:translateY(0);} }

    .records-section {
      margin-top: 16px; padding-top: 18px; border-top: 2px solid #f1f2f6;
      display:none;
    }
    .records-list {
      /* 고정 화면 안에서만 스크롤되도록 높이 확보 */
      max-height: 360px;
      overflow-y: auto;
      background:#f7f9fb; border-radius:12px; padding:10px; margin-top:10px;
    }
    .record-item {
      padding:10px 12px; background:#fff; border-radius:10px; margin-bottom:8px;
      display:flex; justify-content:space-between; align-items:center; font-size:16px;
    }
    .badge {
      display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:800;
      background:#ffeaa7; color:#5c6b70; margin-left:6px;
    }
    .badge-green { background:#55efc4; color:#005d49; }

    /* 내부 섹션 간격 튜닝 */
    .section { margin-bottom: 14px; }
    .spacer { height: 8px; }

  </style>
</head>
<body>
  <div class="stage">
    <div id="app">
      <div class="container">
        <div class="header section">
          <span class="emoji">🦷</span>
          <h1>양치 인증 앱</h1>
          <p>점심시간 양치 체크!</p>
        </div>

        <!-- 등록 폼 -->
        <div id="registration-form" class="section">
          <div class="inline-row">
            <div class="form-group">
              <label class="form-label" for="grade">학년 선택</label>
              <select id="grade" aria-label="학년 선택">
                <option value="">학년을 선택하세요</option>
                <option value="1">1학년</option>
                <option value="2">2학년</option>
                <option value="3">3학년</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" for="class">반 선택</label>
              <select id="class" aria-label="반 선택">
                <option value="">반을 선택하세요</option>
                <option value="1">1반</option>
                <option value="2">2반</option>
                <option value="3">3반</option>
                <option value="4">4반</option>
                <option value="5">5반</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label" for="name">이름 선택</label>
            <select id="name" aria-label="이름 선택">
              <option value="">이름을 선택하세요</option>
            </select>
          </div>

          <div class="helper">
            • 등록 후 <strong>AR 필터</strong>는 새 탭으로 열립니다. 촬영 후 이 페이지로 돌아와 <em>양치 인증 완료</em>를 눌러 주세요.<br/>
            • 점심시간(기본 11:30–13:30) 외에는 경고가 표시됩니다.
          </div>

          <div class="spacer"></div>
          <button class="btn" id="register-btn">등록하기</button>
        </div>

        <!-- 카메라 안내/버튼 -->
        <div class="camera-container section" id="camera-section" aria-live="polite">
          <div class="student-info" id="student-info">
            <h3 id="student-display"></h3>
            <p class="timestamp" id="current-time"></p>
          </div>

          <div class="camera-placeholder">
            <div id="camera-placeholder-content">
              <div style="font-size:56px;">📸</div>
              <p style="margin-top:8px;">AR 필터 페이지는 보안 정책으로</p>
              <p>이 페이지 안에 직접 표시할 수 없어요.</p>
              <button class="btn" id="open-ar-btn" style="margin-top:12px;">AR 필터 열기</button>
              <p style="font-size:14px;margin-top:8px; line-height:1.4;">
                촬영 후 이 탭으로 돌아와 아래의 <strong>양치 인증 완료!</strong>를 눌러 기록하세요.
              </p>
            </div>
          </div>

          <button class="btn" id="complete-btn">양치 인증 완료!</button>
          <button class="btn btn-secondary" id="back-btn">돌아가기</button>

          <div class="success-message" id="success-message">
            <h3 style="margin:0 0 6px;">🎉 양치 인증 완료!</h3>
            <p style="margin:0;">건강한 치아를 위해 노력하는 당신이 멋져요!</p>
          </div>
        </div>

        <!-- 기록 섹션 -->
        <div class="records-section section" id="records-section">
          <h3 style="margin:0;">오늘의 양치 기록</h3>
          <div class="records-list" id="records-list"></div>
          <div class="spacer"></div>
          <button class="btn btn-pink" id="export-btn">엑셀로 내보내기</button>
        </div>

        <!-- 하단 여백 보정 -->
        <div style="flex:1 1 auto;"></div>
      </div>
    </div>
  </div>

  <script>
  // ===== 화면 스케일(1080x1418 고정 캔버스) =====
  function fitToScreen() {
    const app = document.getElementById('app');
    const W = 1080, H = 1418;
    const scale = Math.min(window.innerWidth / W, window.innerHeight / H);
    app.style.transform = `scale(${scale})`;
  }
  window.addEventListener('load', fitToScreen);
  window.addEventListener('resize', fitToScreen);

  // ===== 설정값(점심시간) =====
  const LUNCH_START = { hour: 11, minute: 30 };
  const LUNCH_END   = { hour: 13, minute: 30 };

  // ===== 학생 명렬표 =====
  const studentList = {
    // 1학년
    "1-1": ["강태유","김강율","김강현","김민준","김민호","김범서","김종현","김지섭","김태현","노유하","박서진","박석환","박현빈","송지후","옥채운","이규빈","이기준","이윤건","이인성","이재현","이후현","임라원","임승유","전승민","정교운","조용우","조하랑","한승빈","황지후"],
    "1-2": ["고기훈","김건우","김대건","김민찬","김서환","김승민","김지훈","김형진","남도현","동진호","박민재","박선우","박태성","방수환","배준영","소정우","송재연","송해준","오준석","유도규","이강호","이삭","이유준","임성준","전완영","정명기","조현준","하준우","한인우","황재욱"],
    "1-3": ["고현성","곽태오","김도원","김성규","김성탁","김은호","김진욱","나석민","박도현","박성윤","박준용","방지훈","성민기","신유로","양지웅","엄용준","원연호","윤태웅","이승엽","이예찬","이정림","이태혁","전민찬","정세훈","조범준","채민우","탁동현","한승호","한정우","황윤성"],
    "1-4": ["공범준","권우진","김도훈","김은우","김찬현","김한준","류지훈","모현성","민동휘","박승혁","박용준","배성호","봉건두","신율","안유찬","윤준상","윤태욱","이예준","이준","이지한","이하람","임주원","장민성","장은수","정재원","조민규","채민준","최종윤","한지용","허준혁"],
    "1-5": ["곽선우","김동하","김민성","김민준","김시후","김태현","남훈희","문진우","문현빈","박재현","박준범","박현석","백서우","안주상","유준서","윤준영","윤진규","이상운","이승유","이영준","이준엽","이지안","장동우","정정윤","정현우","조승민","최우현","최재영","허동혁","허신우"],
    // 2학년
    "2-1": ["강서준","곽수민","김나울","김로운","김상율","김선우","김윤찬","김태양","마경진","문찬원","박동후","박민우","배석원","배시우","송해성","안유준","오주환","윤여서","윤예준","이경민","이민준","이은호","이준혁","정효유","조연우","조우형","최명준","최민준","최승현","이찬수"],
    "2-2": ["김다온","김민준","김민찬","김진하","김태훈","김하성","문준영","박순호","박윤승","박은평","박인서","박정후","송금성","신동현","신정호","염승빈","유지호","이교준","이승현","이정민","이태민","임건형","임동건","임지후","임호영","정영로","정찬영","주석현","한현석"],
    "2-3": ["강대현","구정윤","김규민","김도현","김동규","김민준","김이도","김태훈","박정연","박정호","박주현","서동훈","신주환","심재희","안민우","엄상준","염승호","오윤택","오준택","용태윤","유지호","이강","이서윤","이석현","이재승","이현석","전도진","최선우","최재민","한윤제"],
    "2-4": ["강현우","구민혁","김건희","김남우","김민준","김이삭","김현성","노연호","박건우","박예찬","백승민","송시훈","안지민","오건우","용찬중","유준서","윤상호","이승우","이주원","이주현","이현비","이희우","임성진","장은혁","장정우","정우진","정하준","조현욱","차규호","홍준호"],
    // 3학년
    "3-1": ["고규영","권도현","김건민","김도윤","김예송","김준엽","김진우","김진호","김하준","명길민","모지성","박주원","박태현","박효민","소재원","송유건","이동훈","이민호","이윤서","이준영","이현성","이효준","임세진","장철진","전성윤","정하진","최건호","추성보"],
    "3-2": ["강경덕","강신우","강지원","고대영","길하진","김도현","김동현","김민준","김민찬","김성민","김지한","박민형","서준서","선후성","심을지","심지후","우진","이강헌","이범준","이태건","임은서","장건","전지호","정동규","정지호","한인수","황현서"],
    "3-3": ["강준현","강호연","강효준","김영욱","김우찬","김제겸","김지우","김찬섭","김태훈","김현희","박준우","박지민","서지호","신우철","양현준","유태완","이건호","이지환","이찬민","임한","장현명","조준영","최예준","최우윤","최장혁","한래원","함도윤"],
    "3-4": ["강현우","계준형","김민석","김상현","김태랑","김태윤","김현준","김형균","남수호","류지호","문세도","박동민","박시백","손경빈","이강현","이경준","이재윤","이준민","조가온","조민형","조성빈","진준석","차지헌","차현성","최지명","한승우","함상원"],
    "3-5": ["강문규","김단우","김민찬","김시우","김종호","박건","박래원","박서준","박성진","박시우","배현서","송도빈","오민재","유연진","이규연","이성희","이준성","이지후","장은찬","전승균","정희범","조윤민","채주원","최정우","하륜재","한최해긴","황지성"]
  };

  // ===== 상태 =====
  let currentStudent = null;
  let brushingRecords = JSON.parse(localStorage.getItem('brushingRecords') || '[]');

  // ===== (ADD) 시트2 웹훅 설정 & 전송 함수 =====
  const SHEETS_WEBHOOK = 'https://script.google.com/macros/s/AKfycbxh5DZUyTk0Yw1uZXruj7ViUh08FO2vQogfIrLNpOQjm56R8ARL5D1kon9tXTLGsnKEjw/exec'

  async function sendToSheet2(payload) {
    try {
      // preflight(OPTIONS) 피하려고 text/plain으로 전송
      await fetch(SHEETS_WEBHOOK, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
        body: JSON.stringify(payload)
      });
    } catch (e) {
      console.error('시트 전송 실패', e);
    }
  }

  // ===== 유틸 =====
  function isWithinLunch(now = new Date()) {
    const h = now.getHours();
    const m = now.getMinutes();
    const start = LUNCH_START.hour * 60 + LUNCH_START.minute;
    const end   = LUNCH_END.hour   * 60 + LUNCH_END.minute;
    const cur   = h * 60 + m;
    return cur >= start && cur <= end;
  }
  function saveRecords() {
    localStorage.setItem('brushingRecords', JSON.stringify(brushingRecords));
  }
  function updateCurrentTime() {
    const now = new Date();
    const timeString = now.toLocaleString('ko-KR', {
      year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'
    });
    const lunchFlag = isWithinLunch(now) ? '🍽️ 점심시간' : '⏰ 점심시간 외';
    document.getElementById('current-time').textContent = `${lunchFlag} - ${timeString}`;
  }
  function updateRecordsList() {
    const recordsList = document.getElementById('records-list');
    const today = new Date().toLocaleDateString('ko-KR');
    const todayRecords = brushingRecords.filter(r => r.date === today);

    if (todayRecords.length === 0) {
      recordsList.innerHTML = '<p style="text-align:center;color:#636e72;">오늘 기록이 없습니다.</p>';
      return;
    }
    recordsList.innerHTML = todayRecords.map(r => `
      <div class="record-item">
        <span>
          ${r.grade}학년 ${r.class}반 ${r.name}
          ${r.lunchWindow === 'Y'
            ? '<span class="badge badge-green">점심</span>'
            : '<span class="badge">외</span>'}
        </span>
        <span>${r.time}</span>
      </div>
    `).join('');
  }

  // 학년/반 변경 시 이름 옵션 갱신
  function updateNameOptions() {
    const grade = document.getElementById('grade').value;
    const classNum = document.getElementById('class').value;
    const nameSelect = document.getElementById('name');

    nameSelect.innerHTML = '<option value="">이름을 선택하세요</option>';
    if (grade && classNum) {
      const key = `${grade}-${classNum}`;
      const names = studentList[key] || [];
      names.forEach(n => {
        const opt = document.createElement('option');
        opt.value = n;
        opt.textContent = n;
        nameSelect.appendChild(opt);
      });
    }
  }

  // ===== 동작 =====
  function registerStudent() {
    const grade = document.getElementById('grade').value.trim();
    const classNum = document.getElementById('class').value.trim();
    const name = document.getElementById('name').value.trim();
    if (!grade || !classNum || !name) {
      alert('학년, 반, 이름을 모두 선택해주세요!');
      return;
    }
    currentStudent = { grade, class: classNum, name };

    // 폼 숨기고 카메라 섹션 표시
    document.getElementById('registration-form').style.display = 'none';
    document.getElementById('camera-section').style.display = 'flex';
    document.getElementById('student-info').style.display = 'block';

    document.getElementById('student-display').textContent =
      `${currentStudent.grade}학년 ${currentStudent.class}반 ${currentStudent.name}`;
    updateCurrentTime();
  }

  function openAR() {
    window.open(
      'https://www.apoc.day/content/95db481c-d487-46b4-b0f1-a1aa6b484eb7',
      '_blank',
      'noopener'
    );
  }

  // ===== (REPLACE) 기존 takePhoto를 이 버전으로 교체 =====
  function takePhoto() {
    const now = new Date();
    if (!isWithinLunch(now)) {
      const proceed = confirm('지금은 점심시간이 아닙니다. 그래도 인증을 기록할까요?');
      if (!proceed) return;
    }
    const record = {
      ...currentStudent,
      timestamp: now.toISOString(),
      date: now.toLocaleDateString('ko-KR'),
      time: now.toLocaleTimeString('ko-KR'),
      lunchWindow: isWithinLunch(now) ? 'Y' : 'N'
    };

    // (1) 로컬 저장
    brushingRecords.push(record);
    saveRecords();

    // (2) 시트2로 전송
    // Apps Script 웹앱 코드가 시트2에 [날짜,시간,학년,반,이름,점심여부,timestamp]로 appendRow 하도록 되어있다는 전제
    sendToSheet2({
      date: record.date,
      time: record.time,
      grade: record.grade,
      class: record.class,
      name: record.name,
      lunchWindow: record.lunchWindow,
      timestamp: record.timestamp
    });

    // UI 업데이트
    document.getElementById('success-message').style.display = 'block';
    document.getElementById('records-section').style.display = 'block';
    updateRecordsList();

    setTimeout(() => { goBack(); }, 2800);
  }

  function goBack() {
    document.getElementById('camera-section').style.display = 'none';
    document.getElementById('success-message').style.display = 'none';

    document.getElementById('registration-form').style.display = 'block';
    document.getElementById('grade').value = '';
    document.getElementById('class').value = '';
    document.getElementById('name').innerHTML = '<option value="">이름을 선택하세요</option>';

    currentStudent = null;
  }

  function exportToExcel() {
    if (brushingRecords.length === 0) {
      alert('내보낼 기록이 없습니다.');
      return;
    }
    let csvContent = "날짜,시간,학년,반,이름,점심시간여부\n";
    brushingRecords.forEach(r => {
      csvContent += `${r.date},${r.time},${r.grade}학년,${r.class}반,${r.name},${r.lunchWindow || ''}\n`;
    });
    const blob = new Blob(["\uFEFF" + csvContent], { type:'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `양치기록_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  // 이벤트 바인딩
  document.getElementById('grade').addEventListener('change', updateNameOptions);
  document.getElementById('class').addEventListener('change', updateNameOptions);
  document.getElementById('register-btn').addEventListener('click', registerStudent);
  document.getElementById('open-ar-btn').addEventListener('click', openAR);
  document.getElementById('complete-btn').addEventListener('click', takePhoto);
  document.getElementById('back-btn').addEventListener('click', goBack);
  document.getElementById('export-btn').addEventListener('click', exportToExcel);

  // 초기 로드
  window.addEventListener('load', () => {
    if (brushingRecords.length > 0) {
      document.getElementById('records-section').style.display = 'block';
      updateRecordsList();
    }
  });
</script>

 
</body>
</html>
