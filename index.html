<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì–‘ì¹˜ ì¸ì¦ ì•±</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #74b9ff, #0984e3);
      min-height: 100vh; display:flex; align-items:center; justify-content:center; padding:20px;
    }
    .container {
      background:#fff; border-radius:20px; box-shadow:0 20px 40px rgba(0,0,0,0.1);
      padding:30px; width:100%; max-width:420px; text-align:center;
    }
    .header { margin-bottom:30px; }
    .header h1 { color:#2d3436; font-size:28px; margin-bottom:10px; }
    .header .emoji { font-size:48px; margin-bottom:15px; display:block; }

    .form-group { margin-bottom:20px; text-align:left; }
    .form-group label { display:block; margin-bottom:8px; color:#2d3436; font-weight:600; }
    .form-group select, .form-group input {
      width:100%; padding:12px; border:2px solid #ddd; border-radius:10px; font-size:16px;
      transition:border-color .3s;
    }
    .form-group select:focus, .form-group input:focus { outline:none; border-color:#74b9ff; }

    .inline-row { display:flex; gap:10px; }
    .inline-row .form-group { flex:1; margin-bottom:0; }

    .btn {
      background:linear-gradient(135deg, #00b894, #00a085); color:#fff; border:none; padding:14px 24px;
      border-radius:25px; font-size:16px; font-weight:700; cursor:pointer; transition:all .25s;
      width:100%; margin-top:16px;
    }
    .btn:hover { transform:translateY(-2px); box-shadow:0 10px 20px rgba(0,184,148,0.3); }
    .btn:disabled { background:#ddd; cursor:not-allowed; transform:none; box-shadow:none; }
    .btn-secondary { background:#636e72; }
    .btn-pink { background:#fd79a8; }
    .btn-pink:hover { background:#e84393; }

    .camera-container { display:none; flex-direction:column; align-items:center; gap:20px; }
    .camera-placeholder {
      width:300px; height:300px; background:#f8f9fa; border:3px dashed #74b9ff;
      border-radius:15px; display:flex; align-items:center; justify-content:center;
      flex-direction:column; color:#636e72; font-size:16px; padding:16px; text-align:center;
    }

    .student-info {
      background:#f8f9fa; padding:15px; border-radius:10px; margin-bottom:10px; display:none;
      width:100%; text-align:left;
    }
    .student-info h3 { color:#2d3436; margin-bottom:5px; }
    .timestamp { color:#636e72; font-size:14px; }

    .success-message {
      display:none; background:#00b894; color:#fff; padding:16px; border-radius:12px; margin-top:10px;
      animation:fadeIn .5s ease-in;
      width:100%;
    }
    @keyframes fadeIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }

    .records-section { margin-top:24px; padding-top:20px; border-top:2px solid #f1f2f6; display:none; }
    .records-list {
      max-height:220px; overflow-y:auto; background:#f8f9fa; border-radius:10px; padding:10px; margin-top:10px;
    }
    .record-item {
      padding:10px; background:#fff; border-radius:8px; margin-bottom:8px; display:flex; justify-content:space-between;
      align-items:center; font-size:14px;
    }
    .badge {
      display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:700;
      background:#ffeaa7; color:#636e72; margin-left:6px;
    }
    .badge-green { background:#55efc4; color:#006b4f; }

    .helper {
      margin-top:8px; font-size:12px; color:#2d3436; background:#eaf4ff; padding:8px 10px; border-radius:8px; text-align:left;
    }

    @media (max-width:480px){
      .container{ padding:20px; margin:10px; }
      .camera-placeholder{ width:260px; height:260px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <span class="emoji">ğŸ¦·</span>
      <h1>ì–‘ì¹˜ ì¸ì¦ ì•±</h1>
      <p>ì ì‹¬ì‹œê°„ ì–‘ì¹˜ ì²´í¬!</p>
    </div>

    <!-- ë“±ë¡ í¼ -->
    <div id="registration-form">
      <div class="inline-row">
        <div class="form-group">
          <label for="grade">í•™ë…„ ì„ íƒ</label>
          <select id="grade" aria-label="í•™ë…„ ì„ íƒ">
            <option value="">í•™ë…„ì„ ì„ íƒí•˜ì„¸ìš”</option>
            <option value="1">1í•™ë…„</option>
            <option value="2">2í•™ë…„</option>
            <option value="3">3í•™ë…„</option>
            <option value="4">4í•™ë…„</option>
            <option value="5">5í•™ë…„</option>
            <option value="6">6í•™ë…„</option>
          </select>
        </div>
        <div class="form-group">
          <label for="class">ë°˜ ì„ íƒ</label>
          <select id="class" aria-label="ë°˜ ì„ íƒ">
            <option value="">ë°˜ì„ ì„ íƒí•˜ì„¸ìš”</option>
            <option value="1">1ë°˜</option>
            <option value="2">2ë°˜</option>
            <option value="3">3ë°˜</option>
            <option value="4">4ë°˜</option>
            <option value="5">5ë°˜</option>
          </select>
        </div>
      </div>

      <div class="form-group" style="margin-top:16px;">
        <label for="name">ì´ë¦„</label>
        <input type="text" id="name" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" aria-label="ì´ë¦„ ì…ë ¥"/>
      </div>

      <div class="helper">
        â€¢ ë“±ë¡ í›„ <strong>AR í•„í„°</strong>ëŠ” ìƒˆ íƒ­ìœ¼ë¡œ ì—´ë¦½ë‹ˆë‹¤. ì´¬ì˜ í›„ ì´ í˜ì´ì§€ë¡œ ëŒì•„ì™€ <em>ì–‘ì¹˜ ì¸ì¦ ì™„ë£Œ</em>ë¥¼ ëˆŒëŸ¬ ì£¼ì„¸ìš”.<br/>
        â€¢ ì ì‹¬ì‹œê°„(ê¸°ë³¸ 11:30â€“13:30) ì™¸ì—ëŠ” ê²½ê³ ê°€ í‘œì‹œë©ë‹ˆë‹¤.
      </div>

      <button class="btn" id="register-btn">ë“±ë¡í•˜ê¸°</button>
    </div>

    <!-- ì¹´ë©”ë¼ ì•ˆë‚´/ë²„íŠ¼ -->
    <div class="camera-container" id="camera-section" aria-live="polite">
      <div class="student-info" id="student-info">
        <h3 id="student-display"></h3>
        <p class="timestamp" id="current-time"></p>
      </div>

      <div class="camera-placeholder">
        <div id="camera-placeholder-content">
          <div style="font-size:44px;">ğŸ“¸</div>
          <p style="margin-top:8px;">AR í•„í„° í˜ì´ì§€ëŠ” ë³´ì•ˆ ì •ì±…ìœ¼ë¡œ</p>
          <p>ì´ í˜ì´ì§€ ì•ˆì— ì§ì ‘ í‘œì‹œí•  ìˆ˜ ì—†ì–´ìš”.</p>
          <button class="btn" id="open-ar-btn" style="margin-top:12px;">AR í•„í„° ì—´ê¸°</button>
          <p style="font-size:12px;margin-top:8px; line-height:1.4;">
            ì´¬ì˜ í›„ ì´ íƒ­ìœ¼ë¡œ ëŒì•„ì™€ ì•„ë˜ì˜ <strong>ì–‘ì¹˜ ì¸ì¦ ì™„ë£Œ!</strong>ë¥¼ ëˆŒëŸ¬ ê¸°ë¡í•˜ì„¸ìš”.
          </p>
        </div>
      </div>

      <button class="btn" id="complete-btn">ì–‘ì¹˜ ì¸ì¦ ì™„ë£Œ!</button>
      <button class="btn btn-secondary" id="back-btn">ëŒì•„ê°€ê¸°</button>

      <div class="success-message" id="success-message">
        <h3>ğŸ‰ ì–‘ì¹˜ ì¸ì¦ ì™„ë£Œ!</h3>
        <p>ê±´ê°•í•œ ì¹˜ì•„ë¥¼ ìœ„í•´ ë…¸ë ¥í•˜ëŠ” ë‹¹ì‹ ì´ ë©‹ì ¸ìš”!</p>
      </div>
    </div>

    <!-- ê¸°ë¡ ì„¹ì…˜ -->
    <div class="records-section" id="records-section">
      <h3>ì˜¤ëŠ˜ì˜ ì–‘ì¹˜ ê¸°ë¡</h3>
      <div class="records-list" id="records-list"></div>
      <button class="btn btn-pink" id="export-btn">ì—‘ì…€ë¡œ ë‚´ë³´ë‚´ê¸°</button>
    </div>
  </div>

  <script>
    // ===== ì„¤ì •ê°’(ì ì‹¬ì‹œê°„) =====
    const LUNCH_START = { hour: 11, minute: 30 };
    const LUNCH_END   = { hour: 13, minute: 30 };

    // ===== ìƒíƒœ =====
    let currentStudent = null;
    let brushingRecords = JSON.parse(localStorage.getItem('brushingRecords') || '[]');

    // ===== ìœ í‹¸ =====
    function isWithinLunch(now = new Date()) {
      const h = now.getHours();
      const m = now.getMinutes();
      const start = LUNCH_START.hour * 60 + LUNCH_START.minute;
      const end   = LUNCH_END.hour   * 60 + LUNCH_END.minute;
      const cur   = h * 60 + m;
      return cur >= start && cur <= end;
    }

    function saveRecords() {
      localStorage.setItem('brushingRecords', JSON.stringify(brushingRecords));
    }

    function updateCurrentTime() {
      const now = new Date();
      const timeString = now.toLocaleString('ko-KR', {
        year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'
      });
      const lunchFlag = isWithinLunch(now) ? 'ğŸ½ï¸ ì ì‹¬ì‹œê°„' : 'â° ì ì‹¬ì‹œê°„ ì™¸';
      document.getElementById('current-time').textContent = `${lunchFlag} - ${timeString}`;
    }

    function updateRecordsList() {
      const recordsList = document.getElementById('records-list');
      const today = new Date().toLocaleDateString('ko-KR');
      const todayRecords = brushingRecords.filter(r => r.date === today);

      if (todayRecords.length === 0) {
        recordsList.innerHTML = '<p style="text-align:center;color:#636e72;">ì˜¤ëŠ˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }

      recordsList.innerHTML = todayRecords.map(r => `
        <div class="record-item">
          <span>
            ${r.grade}í•™ë…„ ${r.class}ë°˜ ${r.name}
            ${r.lunchWindow === 'Y'
              ? '<span class="badge badge-green">ì ì‹¬</span>'
              : '<span class="badge">ì™¸</span>'}
          </span>
          <span>${r.time}</span>
        </div>
      `).join('');
    }

    // ===== ë™ì‘ =====
    function registerStudent() {
      const grade = document.getElementById('grade').value.trim();
      const classNum = document.getElementById('class').value.trim();
      const name = document.getElementById('name').value.trim();

      if (!grade || !classNum || !name) {
        alert('ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
        return;
      }

      currentStudent = { grade, class: classNum, name };

      // í¼ ìˆ¨ê¸°ê³  ì¹´ë©”ë¼ ì„¹ì…˜ í‘œì‹œ
      document.getElementById('registration-form').style.display = 'none';
      document.getElementById('camera-section').style.display = 'flex';
      document.getElementById('student-info').style.display = 'block';

      // í•™ìƒ ì •ë³´/ì‹œê°„ í‘œì‹œ
      document.getElementById('student-display').textContent =
        `${currentStudent.grade}í•™ë…„ ${currentStudent.class}ë°˜ ${currentStudent.name}`;
      updateCurrentTime();
    }

    function openAR() {
      // ê°™ì€ íƒ­ ì´ë™ì„ ì›í•˜ë©´ window.location.href ì‚¬ìš©
      window.open(
        'https://www.apoc.day/content/95db481c-d487-46b4-b0f1-a1aa6b484eb7',
        '_blank',
        'noopener'
      );
    }

    function takePhoto() {
      const now = new Date();
      if (!isWithinLunch(now)) {
        const proceed = confirm('ì§€ê¸ˆì€ ì ì‹¬ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤. ê·¸ë˜ë„ ì¸ì¦ì„ ê¸°ë¡í• ê¹Œìš”?');
        if (!proceed) return;
      }

      const record = {
        ...currentStudent,
        timestamp: now.toISOString(),
        date: now.toLocaleDateString('ko-KR'),
        time: now.toLocaleTimeString('ko-KR'),
        lunchWindow: isWithinLunch(now) ? 'Y' : 'N'
      };

      brushingRecords.push(record);
      saveRecords();

      document.getElementById('success-message').style.display = 'block';
      document.getElementById('records-section').style.display = 'block';
      updateRecordsList();

      setTimeout(() => { goBack(); }, 3000);
    }

    function goBack() {
      // ì¹´ë©”ë¼ ì„¹ì…˜ ìˆ¨ê¸°ê³  ì„±ê³µ ë©”ì‹œì§€ ìˆ¨ê¹€
      document.getElementById('camera-section').style.display = 'none';
      document.getElementById('success-message').style.display = 'none';

      // í¼ ë‹¤ì‹œ í‘œì‹œ + ì´ˆê¸°í™”
      document.getElementById('registration-form').style.display = 'block';
      document.getElementById('grade').value = '';
      document.getElementById('class').value = '';
      document.getElementById('name').value = '';

      currentStudent = null;
    }

    function exportToExcel() {
      if (brushingRecords.length === 0) {
        alert('ë‚´ë³´ë‚¼ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      let csvContent = "ë‚ ì§œ,ì‹œê°„,í•™ë…„,ë°˜,ì´ë¦„,ì ì‹¬ì‹œê°„ì—¬ë¶€\n";
      brushingRecords.forEach(r => {
        csvContent += `${r.date},${r.time},${r.grade}í•™ë…„,${r.class}ë°˜,${r.name},${r.lunchWindow || ''}\n`;
      });

      const blob = new Blob(["\uFEFF" + csvContent], { type:'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      // YYYY-MM-DD í˜•ì‹ íŒŒì¼ëª…
      link.download = `ì–‘ì¹˜ê¸°ë¡_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // ===== ì´ë²¤íŠ¸ ë°”ì¸ë”© =====
    document.getElementById('register-btn').addEventListener('click', registerStudent);
    document.getElementById('open-ar-btn').addEventListener('click', openAR);
    document.getElementById('complete-btn').addEventListener('click', takePhoto);
    document.getElementById('back-btn').addEventListener('click', goBack);
    document.getElementById('export-btn').addEventListener('click', exportToExcel);

    // ===== ì´ˆê¸° ë¡œë“œ =====
    window.addEventListener('load', () => {
      if (brushingRecords.length > 0) {
        document.getElementById('records-section').style.display = 'block';
        updateRecordsList();
      }
    });
  </script>
</body>
</html>
